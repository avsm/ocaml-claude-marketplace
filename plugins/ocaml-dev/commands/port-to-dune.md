---
description: Convert an ocamlbuild/topkg project to dune build system
argument-hint:
allowed-tools: [Read, Write, Edit, Bash, Glob, Grep]
---

# Port to Dune

This command migrates an OCaml project from ocamlbuild/topkg to dune.

## Arguments

None - operates on the current directory.

## Prerequisites

The command expects to find ocamlbuild artifacts:
- `_tags` - ocamlbuild compilation flags
- `*.mllib` files - module lists for libraries
- `pkg/pkg.ml` - topkg package description (optional)
- `pkg/META` - findlib metadata (optional)
- `opam` - package dependencies

## Migration Process

### 1. Analyze Existing Build

Read and parse:
- `_tags` - Extract package dependencies, compiler flags, thread usage
- `*.mllib` - Identify libraries and their modules
- `pkg/pkg.ml` - Find optional libraries and conditions
- `pkg/META` - Get public library names
- `opam` - Current dependencies

### 2. Create dune-project

```dune
(lang dune 3.20)
(name <package-name>)
(generate_opam_files true)
; ... rest from existing opam metadata
```

### 3. Create Library dune Files

For each library identified from `.mllib` files:

```dune
(library
 (name <library_name>)
 (public_name <package.subname>)
 (libraries <dependencies>))
```

For optional libraries (from `pkg/pkg.ml`):
```dune
(library
 (name <library_name>)
 (public_name <package.subname>)
 (optional)
 (libraries <dependencies>))
```

### 4. Handle Special Cases

**Warning suppression** (if needed):
```dune
(flags (:standard -w -27))
```

**Toplevel init files** (excluded from library):
```dune
(library
 (name lib_name)
 (modules lib_module)
 (libraries deps))

(install
 (package pkg)
 (section lib)
 (files lib_top_init.ml))
```

### 5. Create Test dune Files

```dune
(test
 (name test_name)
 (libraries lib_name alcotest))
```

### 6. Update opam File

- Rename `opam` to `<package>.opam`
- Remove ocamlbuild/topkg dependencies
- Add dune dependency
- Update build commands

### 7. Cleanup

List files to delete (don't delete automatically):
- `_tags`
- `.merlin`
- `pkg/pkg.ml`
- `pkg/META`
- `*.mllib` files
- `*.itarget` files

## Mapping Reference

| ocamlbuild | dune |
|------------|------|
| `_tags: package(foo)` | `(libraries foo)` |
| `_tags: thread` | `(libraries threads)` |
| `foo.mllib` | `(library (name foo))` |
| `pkg/pkg.ml: Pkg.mllib ~cond:x` | `(library ... (optional))` |
| `pkg/META` | Auto-generated by dune |

## Workflow

1. Search for ocamlbuild artifacts
2. Parse each file to understand project structure
3. Create dune-project at root
4. Create dune files for each directory with sources
5. Update opam file
6. Run `dune build @check` to verify
7. List cleanup actions for user to confirm

## Example Usage

```
/port-to-dune
```

## Success Output

```
Analyzed ocamlbuild project structure:
  - Found 3 libraries: logs, logs_fmt, logs_browser
  - Found 2 optional libraries: logs_fmt, logs_browser
  - Found test executable: test_logs

Created dune files:
  - dune-project
  - src/dune
  - src/fmt/dune
  - src/browser/dune
  - test/dune

Updated:
  - logs.opam (renamed from opam, updated build commands)

Files to delete manually:
  - _tags
  - pkg/pkg.ml
  - pkg/META
  - src/logs.mllib
  - src/logs_fmt.mllib
  - src/logs_browser.mllib

Run `dune build` to verify the migration.
```
