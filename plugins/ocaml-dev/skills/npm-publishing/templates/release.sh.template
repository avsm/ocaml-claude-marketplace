#!/bin/bash
# Release script for {{PROJECT_NAME_KEBAB}} npm package
# Run from npm branch after building on main

set -e

# Path to dune install directory
INSTALL_DIR="_build/install/default/share/{{PROJECT_NAME}}-js"

# Check we're on the npm branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" != "npm" ]; then
    echo "Error: Must be on npm branch (currently on $BRANCH)"
    exit 1
fi

# Check the install directory exists
if [ ! -d "$INSTALL_DIR" ]; then
    echo "Error: Install directory not found at $INSTALL_DIR"
    echo "Run 'opam exec -- dune build @install' on main branch first"
    exit 1
fi

# Copy JavaScript files
echo "Copying JavaScript files..."
cp "$INSTALL_DIR/{{PROJECT_NAME}}.js" .

# Copy WASM loader scripts
echo "Copying WASM loader scripts..."
cp "$INSTALL_DIR/{{PROJECT_NAME}}.wasm.js" .

# Copy WASM assets directory
echo "Copying WASM assets..."
rm -rf {{PROJECT_NAME}}_js_main.bc.wasm.assets
cp -r "$INSTALL_DIR/{{PROJECT_NAME}}_js_main.bc.wasm.assets" .

# Fix permissions
echo "Fixing permissions..."
chmod 644 *.js
find {{PROJECT_NAME}}_js_main.bc.wasm.assets -type f -exec chmod 644 {} \;

echo ""
echo "Done! Ready to commit and publish."
echo "Run: git add -A && git commit -m 'Release X.Y.Z' && npm publish"
